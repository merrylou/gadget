<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCHIVE: POMODORO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Source+Code+Pro:wght@400;600;700&display=swap');

        :root {
            --bg-deep: #0a0a0c;
            --bg-surface: #101018;
            --bg-elevated: #18181f;
            --bg-card: #14141a;
            --border-dim: #252530;
            --border-glow: #3a3a48;
            --text-primary: #e8e6e3;
            --text-faded: #8a8a9a;
            --text-muted: #5a5a6a;
            --accent-primary: #00F0FF;
            --accent-glow: #00F0FF;
            --accent-secondary: #00c8d8;
            --accent-success: #7a9f7a;
            --accent-danger: #b57a7a;
            --accent-warning: #b5a06a;
            --shadow-ambient: rgba(0, 0, 0, 0.8);
            --shadow-glow: rgba(0, 240, 255, 0.3);
            --shadow-glow-strong: rgba(0, 240, 255, 0.5);
            --font-mono: 'Share Tech Mono', 'Source Code Pro', 'Courier New', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-mono);
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.7;
            background-image: 
                radial-gradient(ellipse at 20% 20%, rgba(0, 240, 255, 0.02) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 240, 255, 0.015) 0%, transparent 50%);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.03) 2px, rgba(0, 0, 0, 0.03) 4px);
            pointer-events: none;
            z-index: 9999;
        }

        .archive-container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }

        .section-label {
            display: inline-block;
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            color: var(--accent-primary);
            background: var(--bg-deep);
            padding: 0.3rem 0.8rem;
            border: 1px solid var(--border-dim);
            margin-bottom: 1rem;
        }
        .section-label::before { content: '◇'; margin-right: 0.5rem; opacity: 0.6; }

        .archive-header {
            text-align: center;
            padding: 2rem 0 3rem;
            position: relative;
        }
        .archive-header::after {
            content: '';
            position: absolute;
            bottom: 0; left: 50%;
            transform: translateX(-50%);
            width: 60%; height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-glow), transparent);
        }

        .header-title {
            font-size: clamp(1.8rem, 5vw, 3rem);
            font-weight: 700;
            letter-spacing: 0.3em;
            text-shadow: 0 0 30px var(--shadow-glow);
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            font-size: 0.75rem;
            letter-spacing: 0.4em;
            color: var(--text-muted);
        }

        .system-status {
            font-size: 0.65rem;
            color: var(--accent-success);
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 6px; height: 6px;
            background: var(--accent-success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        .archive-section {
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }
        .archive-section::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 3px; height: 100%;
            background: linear-gradient(180deg, var(--accent-primary), transparent);
        }

        .chronometer { text-align: center; padding: 2rem 0; }

        .timer-display {
            position: relative;
            width: 280px; height: 280px;
            margin: 0 auto 2rem;
        }

        .timer-ring { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .timer-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .timer-ring-bg { fill: none; stroke: var(--border-dim); stroke-width: 4; }
        .timer-ring-progress {
            fill: none;
            stroke: var(--accent-primary);
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 816;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 0.5s ease;
            filter: drop-shadow(0 0 10px var(--shadow-glow));
        }
        .timer-ring-progress.break { stroke: var(--accent-success); filter: drop-shadow(0 0 8px rgba(122, 159, 122, 0.3)); }

        .timer-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .timer-time {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-shadow: 0 0 20px var(--shadow-glow);
        }

        .timer-state {
            font-size: 0.7rem;
            letter-spacing: 0.3em;
            color: var(--accent-primary);
            margin-top: 0.5rem;
        }
        .timer-state.break { color: var(--accent-success); }

        .timer-controls { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; }

        .timer-btn {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            padding: 0.8rem 2rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-dim);
            color: var(--text-faded);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .timer-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); box-shadow: 0 0 15px var(--shadow-glow); }
        .timer-btn.primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-color: var(--accent-primary); color: var(--bg-deep); }
        .timer-btn.primary:hover { box-shadow: 0 0 25px var(--shadow-glow-strong); }
        .timer-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .current-focus {
            font-size: 0.9rem;
            color: var(--text-faded);
            padding: 1rem;
            background: var(--bg-elevated);
            border-left: 2px solid var(--accent-primary);
            max-width: 400px;
            margin: 0 auto;
        }
        .current-focus-label { font-size: 0.65rem; color: var(--text-muted); margin-bottom: 0.3rem; }
        .no-focus { color: var(--text-muted); font-style: italic; }

        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }

        .add-task-btn {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            padding: 0.6rem 1.2rem;
            background: var(--bg-elevated);
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .add-task-btn:hover { background: var(--accent-primary); color: var(--bg-deep); box-shadow: 0 0 20px var(--shadow-glow); }

        .task-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }

        /* ==================== */
        /* TASK CARD STYLES     */
        /* ==================== */
        .task-card {
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            padding: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .task-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .task-card:hover { border-color: var(--accent-primary); transform: translateY(-2px); box-shadow: 0 8px 30px var(--shadow-ambient), 0 0 20px var(--shadow-glow); }
        .task-card:hover::before { opacity: 1; }
        .task-card.focused { border-color: var(--accent-primary); box-shadow: 0 0 25px var(--shadow-glow); }
        .task-card.focused::before { opacity: 1; }

        .task-card-header { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: flex-start; }

        /* ==================== */
        /* THUMBNAIL WITH GLOW  */
        /* ==================== */
        .task-thumbnail {
            width: 60px; height: 60px;
            background: var(--bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            flex-shrink: 0;
            position: relative;
            border-radius: 50%;
            /* グレースケール（通常時） */
            filter: grayscale(100%);
            transition: filter 0.4s ease, box-shadow 0.4s ease;
        }

        /* アニメーションする円形ボーダー */
        .task-thumbnail::before {
            content: '';
            position: absolute;
            top: -3px; left: -3px;
            right: -3px; bottom: -3px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: var(--accent-primary);
            border-right-color: var(--accent-primary);
            opacity: 0.4;
            animation: rotate-border 4s linear infinite;
            transition: opacity 0.4s ease, border-color 0.4s ease;
        }

        /* 内側のグロー用 */
        .task-thumbnail::after {
            content: '';
            position: absolute;
            top: -2px; left: -2px;
            right: -2px; bottom: -2px;
            border-radius: 50%;
            border: 1px solid var(--accent-primary);
            opacity: 0;
            box-shadow: 0 0 15px var(--accent-primary), inset 0 0 15px rgba(0, 240, 255, 0.1);
            transition: opacity 0.4s ease;
        }

        @keyframes rotate-border {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ホバー時: カラーに戻る + グロー強化 */
        .task-card:hover .task-thumbnail {
            filter: grayscale(0%);
            box-shadow: 0 0 20px var(--shadow-glow);
        }
        .task-card:hover .task-thumbnail::before {
            opacity: 1;
            border-top-color: var(--accent-primary);
            border-right-color: var(--accent-primary);
            border-bottom-color: transparent;
            border-left-color: transparent;
        }
        .task-card:hover .task-thumbnail::after {
            opacity: 1;
        }

        /* フォーカス時も同様 */
        .task-card.focused .task-thumbnail {
            filter: grayscale(0%);
            box-shadow: 0 0 25px var(--shadow-glow);
        }
        .task-card.focused .task-thumbnail::before {
            opacity: 1;
        }
        .task-card.focused .task-thumbnail::after {
            opacity: 1;
        }

        .task-thumbnail i {
            color: var(--accent-primary);
            position: relative;
            z-index: 1;
        }

        .task-info { flex: 1; min-width: 0; }
        .task-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.3rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-category { font-size: 0.6rem; letter-spacing: 0.1em; color: var(--accent-primary); background: rgba(0, 240, 255, 0.1); padding: 0.2rem 0.5rem; display: inline-block; }
        .task-description { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.4rem; line-height: 1.4; }
        .task-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.65rem; color: var(--text-muted); margin-top: 0.8rem; }
        .task-pomodoro { display: flex; align-items: center; gap: 0.3rem; color: var(--accent-primary); }
        .task-due { color: var(--text-muted); }
        .task-due.overdue { color: var(--accent-danger); }

        .task-actions { display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-dim); }

        .task-action-btn {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            padding: 0.4rem 0.8rem;
            background: transparent;
            border: 1px solid var(--border-dim);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .task-action-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .task-action-btn.complete:hover { border-color: var(--accent-success); color: var(--accent-success); }
        .task-action-btn.delete:hover { border-color: var(--accent-danger); color: var(--accent-danger); }

        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-state i { font-size: 2rem; margin-bottom: 1rem; opacity: 0.5; }

        .database-filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }

        .filter-select {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            padding: 0.5rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-dim);
            color: var(--text-faded);
            cursor: pointer;
        }
        .filter-select:focus { outline: none; border-color: var(--accent-primary); }

        .archive-list { display: flex; flex-direction: column; gap: 0.5rem; }

        .archive-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-elevated);
            border-left: 3px solid var(--accent-primary);
            transition: all 0.2s ease;
        }
        .archive-item:hover { background: var(--bg-card); box-shadow: 0 0 15px var(--shadow-glow); }
        .archive-spine { font-size: 0.6rem; color: var(--text-muted); writing-mode: vertical-rl; text-orientation: mixed; min-width: 20px; }
        .archive-content { flex: 1; }
        .archive-title { font-size: 0.95rem; margin-bottom: 0.3rem; }
        .archive-meta { font-size: 0.6rem; color: var(--text-muted); display: flex; gap: 1rem; flex-wrap: wrap; }

        .system-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .system-card { background: var(--bg-elevated); border: 1px solid var(--border-dim); padding: 1.2rem; }
        .system-card-title { font-size: 0.7rem; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 1rem; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
        .setting-label { font-size: 0.85rem; color: var(--text-faded); }
        .setting-input {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            width: 80px;
            padding: 0.4rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            color: var(--text-primary);
            text-align: center;
        }
        .setting-input:focus { outline: none; border-color: var(--accent-primary); }

        .system-btn {
            width: 100%;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            padding: 0.8rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            color: var(--text-faded);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }
        .system-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .system-btn.danger:hover { border-color: var(--accent-danger); color: var(--accent-danger); }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--bg-surface);
            border: 1px solid var(--accent-primary);
            box-shadow: 0 0 30px var(--shadow-glow);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal { transform: translateY(0); }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 0.8rem; letter-spacing: 0.2em; color: var(--accent-primary); }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; transition: color 0.2s ease; }
        .modal-close:hover { color: var(--accent-primary); }

        .modal-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1.2rem; }
        .form-label { display: block; font-size: 0.65rem; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.5rem; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            font-family: var(--font-mono);
            font-size: 0.95rem;
            padding: 0.8rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-dim);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 10px var(--shadow-glow); }
        .form-textarea { min-height: 100px; resize: vertical; }

        .form-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .form-btn {
            flex: 1;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            padding: 0.8rem;
            border: 1px solid var(--border-dim);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .form-btn.primary { background: var(--accent-primary); border-color: var(--accent-primary); color: var(--bg-deep); }
        .form-btn.primary:hover { box-shadow: 0 0 20px var(--shadow-glow); }
        .form-btn.secondary { background: transparent; color: var(--text-faded); }
        .form-btn.secondary:hover { border-color: var(--text-faded); color: var(--text-primary); }

        .toast {
            position: fixed;
            bottom: 2rem; right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--accent-primary);
            box-shadow: 0 0 20px var(--shadow-glow);
            color: var(--text-primary);
            font-size: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        .priority-high { color: var(--accent-danger); }
        .priority-medium { color: var(--accent-warning); }
        .priority-low { color: var(--accent-success); }

        @media (max-width: 768px) {
            .archive-container { padding: 1rem; }
            .timer-display { width: 220px; height: 220px; }
            .timer-time { font-size: 2.5rem; }
            .task-grid { grid-template-columns: 1fr; }
            .timer-controls { flex-direction: column; align-items: center; }
            .timer-btn { width: 100%; max-width: 200px; }
            .database-filters { flex-direction: column; }
            .filter-select { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="archive-container">
        <header class="archive-header">
            <h1 class="header-title">ARCHIVE: POMODORO</h1>
            <p class="header-subtitle">MEMORY LIBRARY SYSTEM</p>
            <div class="system-status">
                <span class="status-dot"></span>
                <span>SYSTEM: ONLINE</span>
            </div>
        </header>

        <section class="archive-section">
            <span class="section-label">FILE: 00-CHRONOMETER</span>
            <div class="chronometer">
                <div class="timer-display">
                    <div class="timer-ring">
                        <svg viewBox="0 0 280 280">
                            <circle class="timer-ring-bg" cx="140" cy="140" r="130"/>
                            <circle class="timer-ring-progress" id="timerProgress" cx="140" cy="140" r="130"/>
                        </svg>
                    </div>
                    <div class="timer-center">
                        <div class="timer-time" id="timerDisplay">25:00</div>
                        <div class="timer-state" id="timerState">WORK SESSION</div>
                    </div>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn primary" id="startBtn">START</button>
                    <button class="timer-btn" id="pauseBtn" disabled>PAUSE</button>
                    <button class="timer-btn" id="resetBtn">RESET</button>
                </div>
                <div class="current-focus">
                    <div class="current-focus-label">CURRENT SUBJECT:</div>
                    <div id="currentFocus" class="no-focus">— 未選択 —</div>
                </div>
            </div>
        </section>

        <section class="archive-section">
            <div class="task-header">
                <span class="section-label">FILE: 01-SUBJECTS</span>
                <button class="add-task-btn" id="addTaskBtn"><i class="fas fa-plus"></i> NEW ENTRY</button>
            </div>
            <div class="task-grid" id="taskGrid"></div>
            <div class="empty-state" id="emptyTasks" style="display: none;">
                <i class="fas fa-book-open"></i>
                <p>アーカイブする物語がありません</p>
            </div>
        </section>

        <section class="archive-section">
            <span class="section-label">FILE: 02-DATABASE</span>
            <div class="database-filters">
                <select class="filter-select" id="filterCategory"><option value="">ALL CATEGORIES</option></select>
                <select class="filter-select" id="filterDate">
                    <option value="">ALL TIME</option>
                    <option value="today">TODAY</option>
                    <option value="week">THIS WEEK</option>
                    <option value="month">THIS MONTH</option>
                </select>
            </div>
            <div class="archive-list" id="archiveList"></div>
            <div class="empty-state" id="emptyArchive" style="display: none;">
                <i class="fas fa-archive"></i>
                <p>完了した記録はありません</p>
            </div>
        </section>

        <section class="archive-section">
            <span class="section-label">FILE: 99-SYSTEM</span>
            <div class="system-grid">
                <div class="system-card">
                    <div class="system-card-title">TIMER SETTINGS</div>
                    <div class="setting-row">
                        <span class="setting-label">作業時間（分）</span>
                        <input type="number" class="setting-input" id="workDuration" value="25" min="1" max="60">
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">短い休憩（分）</span>
                        <input type="number" class="setting-input" id="shortBreak" value="5" min="1" max="30">
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">長い休憩（分）</span>
                        <input type="number" class="setting-input" id="longBreak" value="15" min="1" max="60">
                    </div>
                    <button class="system-btn" id="saveSettings">SAVE SETTINGS</button>
                </div>
                <div class="system-card">
                    <div class="system-card-title">NOTIFICATION</div>
                    <div class="setting-row">
                        <span class="setting-label">通知音</span>
                        <select class="setting-input" id="soundEnabled" style="width: auto;">
                            <option value="1">ON</option>
                            <option value="0">OFF</option>
                        </select>
                    </div>
                    <button class="system-btn" id="requestNotification">ENABLE NOTIFICATIONS</button>
                </div>
                <div class="system-card">
                    <div class="system-card-title">DATA MANAGEMENT</div>
                    <button class="system-btn" id="exportData">EXPORT DATA</button>
                    <button class="system-btn danger" id="clearData">CLEAR ALL DATA</button>
                </div>
            </div>
        </section>
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">NEW ENTRY</span>
                <button class="modal-close" id="modalClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId">
                    <div class="form-group">
                        <label class="form-label">TITLE</label>
                        <input type="text" class="form-input" id="taskTitle" required placeholder="タスクのタイトル">
                    </div>
                    <div class="form-group">
                        <label class="form-label">DESCRIPTION</label>
                        <textarea class="form-textarea" id="taskDescription" placeholder="詳細な説明（任意）"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CATEGORY</label>
                        <input type="text" class="form-input" id="taskCategory" list="categoryList" placeholder="カテゴリを入力または選択">
                        <datalist id="categoryList"></datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">PRIORITY</label>
                        <select class="form-select" id="taskPriority">
                            <option value="low">LOW</option>
                            <option value="medium" selected>MEDIUM</option>
                            <option value="high">HIGH</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">DUE DATE</label>
                        <input type="date" class="form-input" id="taskDueDate">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="form-btn secondary" id="cancelTask">CANCEL</button>
                        <button type="submit" class="form-btn primary">SAVE</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    class DatabaseManager {
        constructor() { this.dbName = 'ArchivePomodoroDB'; this.dbVersion = 1; this.db = null; }
        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.dbName, this.dbVersion);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { this.db = request.result; resolve(this.db); };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('tasks')) {
                        const taskStore = db.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true });
                        taskStore.createIndex('completed', 'completed', { unique: false });
                        taskStore.createIndex('category', 'category', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                };
            });
        }
        async getAll(storeName) { return new Promise((resolve, reject) => { const tx = this.db.transaction(storeName, 'readonly'); const store = tx.objectStore(storeName); const req = store.getAll(); req.onerror = () => reject(req.error); req.onsuccess = () => resolve(req.result); }); }
        async get(storeName, key) { return new Promise((resolve, reject) => { const tx = this.db.transaction(storeName, 'readonly'); const store = tx.objectStore(storeName); const req = store.get(key); req.onerror = () => reject(req.error); req.onsuccess = () => resolve(req.result); }); }
        async add(storeName, data) { return new Promise((resolve, reject) => { const tx = this.db.transaction(storeName, 'readwrite'); const store = tx.objectStore(storeName); const req = store.add(data); req.onerror = () => reject(req.error); req.onsuccess = () => resolve(req.result); }); }
        async put(storeName, data) { return new Promise((resolve, reject) => { const tx = this.db.transaction(storeName, 'readwrite'); const store = tx.objectStore(storeName); const req = store.put(data); req.onerror = () => reject(req.error); req.onsuccess = () => resolve(req.result); }); }
        async delete(storeName, key) { return new Promise((resolve, reject) => { const tx = this.db.transaction(storeName, 'readwrite'); const store = tx.objectStore(storeName); const req = store.delete(key); req.onerror = () => reject(req.error); req.onsuccess = () => resolve(req.result); }); }
        async clear(storeName) { return new Promise((resolve, reject) => { const tx = this.db.transaction(storeName, 'readwrite'); const store = tx.objectStore(storeName); const req = store.clear(); req.onerror = () => reject(req.error); req.onsuccess = () => resolve(req.result); }); }
    }

    class PomodoroTimer {
        constructor(onTick, onComplete, onStateChange) {
            this.states = { WORK: 'WORK SESSION', SHORT_BREAK: 'SHORT BREAK', LONG_BREAK: 'LONG BREAK' };
            this.currentState = this.states.WORK;
            this.pomodoroCount = 0;
            this.settings = { workDuration: 25, shortBreak: 5, longBreak: 15 };
            this.timeRemaining = this.settings.workDuration * 60;
            this.totalTime = this.timeRemaining;
            this.isRunning = false;
            this.intervalId = null;
            this.onTick = onTick; this.onComplete = onComplete; this.onStateChange = onStateChange;
        }
        updateSettings(s) { this.settings = { ...this.settings, ...s }; if (!this.isRunning) this.reset(); }
        start() { if (this.isRunning) return; this.isRunning = true; this.intervalId = setInterval(() => this.tick(), 1000); }
        pause() { this.isRunning = false; if (this.intervalId) { clearInterval(this.intervalId); this.intervalId = null; } }
        reset() { this.pause(); this.currentState = this.states.WORK; this.timeRemaining = this.settings.workDuration * 60; this.totalTime = this.timeRemaining; this.onTick(this.timeRemaining, this.totalTime); this.onStateChange(this.currentState); }
        tick() { this.timeRemaining--; this.onTick(this.timeRemaining, this.totalTime); if (this.timeRemaining <= 0) this.completeSession(); }
        completeSession() {
            this.pause();
            if (this.currentState === this.states.WORK) { this.pomodoroCount++; this.onComplete(true); this.currentState = this.pomodoroCount % 4 === 0 ? this.states.LONG_BREAK : this.states.SHORT_BREAK; this.timeRemaining = (this.pomodoroCount % 4 === 0 ? this.settings.longBreak : this.settings.shortBreak) * 60; }
            else { this.currentState = this.states.WORK; this.timeRemaining = this.settings.workDuration * 60; this.onComplete(false); }
            this.totalTime = this.timeRemaining; this.onStateChange(this.currentState); this.onTick(this.timeRemaining, this.totalTime);
        }
    }

    class ArchivePomodoro {
        constructor() { this.db = new DatabaseManager(); this.timer = null; this.focusedTaskId = null; this.tasks = []; this.categories = new Set(); this.audioContext = null; }
        async init() { await this.db.init(); await this.loadSettings(); await this.loadTasks(); this.initTimer(); this.bindEvents(); this.render(); }
        initTimer() { this.timer = new PomodoroTimer((r, t) => this.updateTimerDisplay(r, t), (w) => this.handleSessionComplete(w), (s) => this.handleStateChange(s)); }
        async loadSettings() {
            const wd = await this.db.get('settings', 'workDuration'), sb = await this.db.get('settings', 'shortBreak'), lb = await this.db.get('settings', 'longBreak'), se = await this.db.get('settings', 'soundEnabled');
            document.getElementById('workDuration').value = wd?.value || 25; document.getElementById('shortBreak').value = sb?.value || 5; document.getElementById('longBreak').value = lb?.value || 15; document.getElementById('soundEnabled').value = se?.value ?? 1;
            if (this.timer) this.timer.updateSettings({ workDuration: wd?.value || 25, shortBreak: sb?.value || 5, longBreak: lb?.value || 15 });
        }
        async loadTasks() { this.tasks = await this.db.getAll('tasks'); this.categories.clear(); this.tasks.forEach(t => { if (t.category) this.categories.add(t.category); }); }
        bindEvents() {
            document.getElementById('startBtn').addEventListener('click', () => this.startTimer());
            document.getElementById('pauseBtn').addEventListener('click', () => this.pauseTimer());
            document.getElementById('resetBtn').addEventListener('click', () => this.resetTimer());
            document.getElementById('addTaskBtn').addEventListener('click', () => this.openTaskModal());
            document.getElementById('modalClose').addEventListener('click', () => this.closeTaskModal());
            document.getElementById('cancelTask').addEventListener('click', () => this.closeTaskModal());
            document.getElementById('taskForm').addEventListener('submit', (e) => this.handleTaskSubmit(e));
            document.getElementById('taskModal').addEventListener('click', (e) => { if (e.target.id === 'taskModal') this.closeTaskModal(); });
            document.getElementById('filterCategory').addEventListener('change', () => this.renderArchive());
            document.getElementById('filterDate').addEventListener('change', () => this.renderArchive());
            document.getElementById('saveSettings').addEventListener('click', () => this.saveSettings());
            document.getElementById('requestNotification').addEventListener('click', () => this.requestNotificationPermission());
            document.getElementById('exportData').addEventListener('click', () => this.exportData());
            document.getElementById('clearData').addEventListener('click', () => this.clearAllData());
        }
        startTimer() { this.timer.start(); document.getElementById('startBtn').disabled = true; document.getElementById('pauseBtn').disabled = false; }
        pauseTimer() { this.timer.pause(); document.getElementById('startBtn').disabled = false; document.getElementById('pauseBtn').disabled = true; }
        resetTimer() { this.timer.reset(); document.getElementById('startBtn').disabled = false; document.getElementById('pauseBtn').disabled = true; }
        updateTimerDisplay(r, t) { const m = Math.floor(r / 60), s = r % 60; document.getElementById('timerDisplay').textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; const c = 2 * Math.PI * 130, o = c * (1 - (r / t)); document.getElementById('timerProgress').style.strokeDashoffset = o; }
        handleStateChange(state) { const el = document.getElementById('timerState'), pg = document.getElementById('timerProgress'); el.textContent = state; if (state !== 'WORK SESSION') { el.classList.add('break'); pg.classList.add('break'); } else { el.classList.remove('break'); pg.classList.remove('break'); } }
        async handleSessionComplete(isWork) { if (isWork && this.focusedTaskId) { const t = this.tasks.find(x => x.id === this.focusedTaskId); if (t) { t.pomodoroCount = (t.pomodoroCount || 0) + 1; await this.db.put('tasks', t); this.render(); } } this.playNotificationSound(); this.showDesktopNotification(isWork ? '作業セッション完了！' : '休憩終了！', isWork ? '休憩を取りましょう' : '作業を再開しましょう'); this.showToast(isWork ? 'セッション完了！休憩を取りましょう' : '休憩終了！作業を再開しましょう'); }
        openTaskModal(taskId = null) {
            const modal = document.getElementById('taskModal'), form = document.getElementById('taskForm'), title = document.getElementById('modalTitle'), dl = document.getElementById('categoryList');
            dl.innerHTML = ''; this.categories.forEach(c => { const o = document.createElement('option'); o.value = c; dl.appendChild(o); });
            if (taskId) { const t = this.tasks.find(x => x.id === taskId); if (t) { title.textContent = 'EDIT ENTRY'; document.getElementById('taskId').value = t.id; document.getElementById('taskTitle').value = t.title; document.getElementById('taskDescription').value = t.description || ''; document.getElementById('taskCategory').value = t.category || ''; document.getElementById('taskPriority').value = t.priority || 'medium'; document.getElementById('taskDueDate').value = t.dueDate || ''; } }
            else { title.textContent = 'NEW ENTRY'; form.reset(); document.getElementById('taskId').value = ''; }
            modal.classList.add('active');
        }
        closeTaskModal() { document.getElementById('taskModal').classList.remove('active'); }
        async handleTaskSubmit(e) {
            e.preventDefault(); const taskId = document.getElementById('taskId').value;
            const data = { title: document.getElementById('taskTitle').value, description: document.getElementById('taskDescription').value, category: document.getElementById('taskCategory').value, priority: document.getElementById('taskPriority').value, dueDate: document.getElementById('taskDueDate').value, completed: false, pomodoroCount: 0, createdAt: new Date().toISOString() };
            if (taskId) { const ex = this.tasks.find(x => x.id === parseInt(taskId)); data.id = parseInt(taskId); data.pomodoroCount = ex?.pomodoroCount || 0; data.createdAt = ex?.createdAt || data.createdAt; await this.db.put('tasks', data); this.showToast('タスクを更新しました'); }
            else { await this.db.add('tasks', data); this.showToast('新しいタスクを追加しました'); }
            await this.loadTasks(); this.render(); this.closeTaskModal();
        }
        async deleteTask(id) { if (confirm('このタスクを削除しますか？')) { await this.db.delete('tasks', id); if (this.focusedTaskId === id) { this.focusedTaskId = null; this.updateFocusDisplay(); } await this.loadTasks(); this.render(); this.showToast('タスクを削除しました'); } }
        async completeTask(id) { const t = this.tasks.find(x => x.id === id); if (t) { t.completed = true; t.completedAt = new Date().toISOString(); await this.db.put('tasks', t); if (this.focusedTaskId === id) { this.focusedTaskId = null; this.updateFocusDisplay(); } await this.loadTasks(); this.render(); this.showToast('タスクをアーカイブしました'); } }
        focusTask(id) { this.focusedTaskId = id; this.updateFocusDisplay(); this.render(); }
        updateFocusDisplay() { const el = document.getElementById('currentFocus'); if (this.focusedTaskId) { const t = this.tasks.find(x => x.id === this.focusedTaskId); if (t) { el.textContent = t.title; el.classList.remove('no-focus'); } } else { el.textContent = '— 未選択 —'; el.classList.add('no-focus'); } }
        async saveSettings() { const s = { workDuration: parseInt(document.getElementById('workDuration').value), shortBreak: parseInt(document.getElementById('shortBreak').value), longBreak: parseInt(document.getElementById('longBreak').value), soundEnabled: parseInt(document.getElementById('soundEnabled').value) }; await this.db.put('settings', { key: 'workDuration', value: s.workDuration }); await this.db.put('settings', { key: 'shortBreak', value: s.shortBreak }); await this.db.put('settings', { key: 'longBreak', value: s.longBreak }); await this.db.put('settings', { key: 'soundEnabled', value: s.soundEnabled }); this.timer.updateSettings(s); this.showToast('設定を保存しました'); }
        async requestNotificationPermission() { if ('Notification' in window) { const p = await Notification.requestPermission(); this.showToast(p === 'granted' ? '通知が有効になりました' : '通知が拒否されました'); } else { this.showToast('このブラウザは通知をサポートしていません'); } }
        showDesktopNotification(title, body) { if ('Notification' in window && Notification.permission === 'granted') new Notification(title, { body }); }
        playNotificationSound() { if (document.getElementById('soundEnabled').value === '0') return; if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)(); const o = this.audioContext.createOscillator(), g = this.audioContext.createGain(); o.connect(g); g.connect(this.audioContext.destination); o.frequency.value = 800; o.type = 'sine'; g.gain.setValueAtTime(0.3, this.audioContext.currentTime); g.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5); o.start(this.audioContext.currentTime); o.stop(this.audioContext.currentTime + 0.5); }
        async exportData() { const d = { tasks: this.tasks, exportedAt: new Date().toISOString() }; const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `archive-pomodoro-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(u); this.showToast('データをエクスポートしました'); }
        async clearAllData() { if (confirm('すべてのデータを削除しますか？この操作は取り消せません。')) { await this.db.clear('tasks'); await this.db.clear('settings'); this.tasks = []; this.categories.clear(); this.focusedTaskId = null; this.updateFocusDisplay(); this.render(); this.showToast('すべてのデータを削除しました'); } }
        render() { this.renderTasks(); this.renderArchive(); this.renderCategoryFilter(); }
        getCategoryIcon(c) { const i = { '仕事': 'fa-briefcase', '勉強': 'fa-graduation-cap', '読書': 'fa-book', '運動': 'fa-dumbbell', '趣味': 'fa-palette', 'プログラミング': 'fa-code', '会議': 'fa-users', 'メール': 'fa-envelope', '企画': 'fa-lightbulb', '資料作成': 'fa-file-alt' }; return i[c] || 'fa-bookmark'; }
        renderTasks() {
            const grid = document.getElementById('taskGrid'), empty = document.getElementById('emptyTasks'), active = this.tasks.filter(t => !t.completed);
            if (active.length === 0) { grid.innerHTML = ''; empty.style.display = 'block'; return; }
            empty.style.display = 'none';
            grid.innerHTML = active.map(t => {
                const overdue = t.dueDate && new Date(t.dueDate) < new Date(), focused = t.id === this.focusedTaskId;
                return `<div class="task-card ${focused ? 'focused' : ''}" data-id="${t.id}">
                    <div class="task-card-header">
                        <div class="task-thumbnail"><i class="fas ${this.getCategoryIcon(t.category)}"></i></div>
                        <div class="task-info">
                            <div class="task-title">${this.escapeHtml(t.title)}</div>
                            ${t.category ? `<span class="task-category">${this.escapeHtml(t.category)}</span>` : ''}
                            ${t.description ? `<div class="task-description">${this.escapeHtml(t.description).substring(0, 50)}${t.description.length > 50 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                    <div class="task-meta">
                        <span class="task-pomodoro"><i class="fas fa-clock"></i> ${t.pomodoroCount || 0}</span>
                        ${t.dueDate ? `<span class="task-due ${overdue ? 'overdue' : ''}">${t.dueDate}</span>` : ''}
                        <span class="priority-${t.priority}"><i class="fas fa-flag"></i></span>
                    </div>
                    <div class="task-actions">
                        <button class="task-action-btn" onclick="app.focusTask(${t.id})"><i class="fas fa-crosshairs"></i> FOCUS</button>
                        <button class="task-action-btn" onclick="app.openTaskModal(${t.id})"><i class="fas fa-edit"></i> EDIT</button>
                        <button class="task-action-btn complete" onclick="app.completeTask(${t.id})"><i class="fas fa-check"></i> DONE</button>
                        <button class="task-action-btn delete" onclick="app.deleteTask(${t.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }
        renderArchive() {
            const list = document.getElementById('archiveList'), empty = document.getElementById('emptyArchive'), cf = document.getElementById('filterCategory').value, df = document.getElementById('filterDate').value;
            let archived = this.tasks.filter(t => t.completed);
            if (cf) archived = archived.filter(t => t.category === cf);
            if (df) { const now = new Date(), sod = new Date(now.getFullYear(), now.getMonth(), now.getDate()), sow = new Date(sod); sow.setDate(sow.getDate() - sow.getDay()); const som = new Date(now.getFullYear(), now.getMonth(), 1); archived = archived.filter(t => { const c = new Date(t.completedAt); return df === 'today' ? c >= sod : df === 'week' ? c >= sow : df === 'month' ? c >= som : true; }); }
            if (archived.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; return; }
            empty.style.display = 'none';
            list.innerHTML = archived.map((t, i) => `<div class="archive-item"><div class="archive-spine">#${String(i + 1).padStart(3, '0')}</div><div class="archive-content"><div class="archive-title">${this.escapeHtml(t.title)}</div><div class="archive-meta"><span><i class="fas fa-clock"></i> ${t.pomodoroCount || 0} pomodoros</span>${t.category ? `<span><i class="fas fa-tag"></i> ${this.escapeHtml(t.category)}</span>` : ''}<span><i class="fas fa-calendar-check"></i> ${t.completedAt ? new Date(t.completedAt).toLocaleDateString('ja-JP') : ''}</span></div></div></div>`).join('');
        }
        renderCategoryFilter() { const s = document.getElementById('filterCategory'), v = s.value; s.innerHTML = '<option value="">ALL CATEGORIES</option>'; this.categories.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; s.appendChild(o); }); s.value = v; }
        escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    }

    const app = new ArchivePomodoro();
    app.init().catch(console.error);
    </script>
</body>
</html>
